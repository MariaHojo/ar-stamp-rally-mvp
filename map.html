<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>マップ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .map-wrap { position: relative; max-width: 900px; margin: 12px auto; }
    .map-image { width: 100%; height: auto; display: block; border-radius: 12px; box-shadow: 0 6px 24px rgba(0,0,0,.08); }
    .pin { position: absolute; width: 44px; height: 44px; transform: translate(-50%, -100%); display: block; border: none; background: transparent; padding: 0; cursor: pointer; }
    .pin img { width: 100%; height: 100%; display: block; }
    .legend { max-width: 900px; margin: 8px auto 0; padding: 8px 12px; font-size: 14px; background: #f6f7fb; border-radius: 10px; color: #333; }
    .legend strong { color: #0a58ca; }
    #mapContainer { max-width: 900px; margin: 0 auto; }

    /* スタンプ帳 */
    .stamp-toggle { margin-left: 8px; }
    .stamp-book { max-width: 900px; margin: 10px auto; display: none; }
    .stamps-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .stamp-cell { background: #fff; border-radius: 12px; padding: 12px; box-shadow: 0 4px 16px rgba(0,0,0,.06); text-align: center; }
    .stamp-img { width: 100%; max-width: 140px; height: auto; display: block; margin: 6px auto 4px; }
    .stamp-placeholder { width: 100%; max-width: 140px; margin: 6px auto 4px; padding: 28px 0; border: 2px dashed #c7c7c7; border-radius: 10px; color: #888; font-weight: 600; }
    .stamp-label { font-size: 12px; color: #555; }
    .stamp-status { font-size: 13px; font-weight: 600; margin-top: 2px; }
    .obtained { color: #1a7f37; }
    .not-obtained { color: #b02a37; }
  </style>
</head>
<body>
  <!-- メニューバー -->
  <div id="menuBar" style="max-width:900px;margin:0 auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
    <a href="tutorial.html">チュートリアル</a> |
    <a href="terms.html" target="_blank" rel="noopener">利用規約</a>
    <button id="stampToggle" class="stamp-toggle" type="button">▼スタンプ帳</button>
  </div>

  <!-- スタンプ帳（折りたたみ） -->
  <div id="stampBook" class="stamp-book">
    <div class="stamps-grid">
      <div class="stamp-cell" data-spot="spot1">
        <div class="stamp-label">スポット1</div>
        <img id="stamp1Img" class="stamp-img" src="assets/images/stamp01.png" alt="スタンプ1" style="display:none;">
        <div id="stamp1Placeholder" class="stamp-placeholder">未取得</div>
        <div id="stamp1Status" class="stamp-status not-obtained">未取得</div>
      </div>
      <div class="stamp-cell" data-spot="spot2">
        <div class="stamp-label">スポット2</div>
        <img id="stamp2Img" class="stamp-img" src="assets/images/stamp02.png" alt="スタンプ2" style="display:none;">
        <div id="stamp2Placeholder" class="stamp-placeholder">未取得</div>
        <div id="stamp2Status" class="stamp-status not-obtained">未取得</div>
      </div>
      <div class="stamp-cell" data-spot="spot3">
        <div class="stamp-label">スポット3</div>
        <img id="stamp3Img" class="stamp-img" src="assets/images/stamp03.png" alt="スタンプ3" style="display:none;">
        <div id="stamp3Placeholder" class="stamp-placeholder">未取得</div>
        <div id="stamp3Status" class="stamp-status not-obtained">未取得</div>
      </div>
    </div>
  </div>

  <!-- 地図画像＋ピン -->
  <div id="mapContainer">
    <div class="map-wrap">
      <img src="assets/images/campus-map.png" alt="学内マップ" class="map-image" id="mapImage" />

      <!-- ピン（クリックで経路案内＆lastSpotId保存） -->
      <button class="pin" style="left:32%; top:58%;" aria-label="スポット1"
              data-spot="spot1" data-lat="35.686917" data-lng="139.529194" data-label="Spot1">
        <img src="assets/images/map_pin.png" alt="スポット1">
      </button>

      <button class="pin" style="left:61%; top:41%;" aria-label="スポット2"
              data-spot="spot2" data-lat="35.686139" data-lng="139.533056" data-label="Spot2">
        <img src="assets/images/map_pin.png" alt="スポット2">
      </button>

      <button class="pin" style="left:78%; top:72%;" aria-label="スポット3"
              data-spot="spot3" data-lat="35.685667" data-lng="139.530889" data-label="Spot3">
        <img src="assets/images/map_pin.png" alt="スポット3">
      </button>
    </div>

    <div class="legend">
      <p>ピンをタップすると地図アプリが開きます。スポット到着後に「カメラ起動」からARに進み、スタンプを取得してください。</p>
    </div>
  </div>

  <!-- カメラ起動ボタン（lastSpotId を使って 8th Wall を開く） -->
  <div style="max-width:900px;margin:16px auto 40px;">
    <button id="cameraBtn" type="button">カメラ起動</button>
  </div>

  <!-- スクリプト：必ずこの順（firebase → ページ固有） -->
  <script src="js/firebase.js?v=2" defer></script>
  <script src="js/map.js?v=2" defer></script>

  <!-- firebase 準備完了/画面復帰でスタンプ再読込 -->
  <script defer>
    document.addEventListener('firebase-ready', () => window.loadAndRenderStamps && window.loadAndRenderStamps());
    window.addEventListener('pageshow', () => window.loadAndRenderStamps && window.loadAndRenderStamps());
  </script>
</body>
</html>
