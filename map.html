<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>マップ | ARスタンプラリー</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <link rel="stylesheet" href="css/style.css">
  <style>
    /* ---- 上部バーの3分割レイアウト ---- */
    #menuBar {
      position: sticky; /* 上部固定 */
      top: 0;
      z-index: 1000;
      background: #f9f9f9;
      border-bottom: 1px solid #ddd;
      padding: 8px 12px;
    }
    .menubar-inner {
      display: grid;
      grid-template-columns: 1fr auto 1fr; /* 左：リンク群 / 中央：スタンプ帳 / 右：言語 */
      align-items: center;
      gap: 8px;
      max-width: 980px;
      margin: 0 auto;
    }
    .mb-left, .mb-center, .mb-right { display: flex; align-items: center; }
    .mb-left { gap: 10px; justify-content: flex-start; }
    .mb-center { justify-content: center; position: relative; } /* ← ドロップダウンの基準 */
    .mb-right { justify-content: flex-end; gap: 8px; }

    .mb-link, .mb-btn {
      color: #005ABB;
      font-weight: 600;
      text-decoration: none;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
      padding: 6px 8px;
      border-radius: 8px;
    }
    .mb-link:hover, .mb-btn:hover { background: #eef4ff; }

    /* ---- スタンプ帳（ドロップダウン化） ---- */
    #stampToggleBtn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #005ABB;
      color: #fff;
      border: 0;
      border-radius: 10px;
      padding: 8px 12px;
      font-weight: 800;
      box-shadow: 0 6px 16px rgba(0,90,187,.2);
    }
    #stampBook {
      position: absolute;           /* ← 他要素を押し下げない */
      top: calc(100% + 8px);        /* トグルボタンの下に表示 */
      left: 50%;
      transform: translateX(-50%);
      width: min(92vw, 520px);
      max-height: 60vh;
      overflow: auto;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      box-shadow: 0 18px 40px rgba(0,0,0,.18);
      padding: 12px;
      display: none;                /* 既定は閉じる */
      z-index: 1200;
    }
    #stampBook.open { display: block; }
    .stamp-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
    }
    .stamp-cell {
      width: 60px; height: 60px;
      border: 1px dashed #cbd5e1;
      border-radius: 10px;
      display: grid; place-items: center;
      background: #fafafa;
    }
    .stamp-cell img { width: 100%; height: 100%; object-fit: contain; }

    /* ---- 言語アイコン ---- */
    #langBtn {
      width: 28px; height: 28px; display: inline-block;
    }
    #langBtn img { width: 28px; height: 28px; display: block; }

    /* ---- コンテンツ領域 ---- */
    .page-container { max-width: 980px; margin: 10px auto; padding: 0 12px; }

    /* 完走リンク行（文言更新対応） */
    .complete-row {
      display: none; /* map.js 側で達成時に表示切替する想定 */
      background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 10px 12px;
      margin: 10px 0; display: flex; align-items: center; justify-content: space-between; gap: 10px;
    }
    .complete-row a {
      text-decoration: none; font-weight: 800; color: #005ABB;
      background: #eef4ff; padding: 8px 12px; border-radius: 10px;
    }

    /* モーダル（写真グリッド等）は既存の style.css を使用 */
    @media (max-width: 480px){
      .stamp-grid { grid-template-columns: repeat(6, 44px); }
      .stamp-cell { width: 44px; height: 44px; }
    }
  </style>
</head>
<body>
  <!-- 上部メニューバー -->
  <div id="menuBar" role="navigation" aria-label="画面上部メニュー">
    <div class="menubar-inner">
      <!-- 左：各種リンク -->
      <div class="mb-left">
        <a class="mb-link" href="terms.html">プライバシーポリシー・ご利用上の注意</a>
        <a class="mb-link" href="tutorial.html">チュートリアル</a>
      </div>

      <!-- 中央：スタンプ帳（ドロップダウン） -->
      <div class="mb-center">
        <button id="stampToggleBtn" class="mb-btn" type="button">スタンプ帳</button>
        <div id="stampBook" class="stamp-book" aria-label="スタンプ帳">
          <div class="stamp-grid" id="stampGrid">
            <!-- map.js でスタンプ状態に応じて差し替え／ここはプレース -->
            <div class="stamp-cell"><img alt="stamp1" src="assets/images/stamps/stamp01.png"></div>
            <div class="stamp-cell"><img alt="stamp2" src="assets/images/stamps/stamp02.png"></div>
            <div class="stamp-cell"><img alt="stamp3" src="assets/images/stamps/stamp03.png"></div>
            <div class="stamp-cell"><img alt="stamp4" src="assets/images/stamps/stamp04.png"></div>
            <div class="stamp-cell"><img alt="stamp5" src="assets/images/stamps/stamp05.png"></div>
            <div class="stamp-cell"><img alt="stamp6" src="assets/images/stamps/stamp06.png"></div>
          </div>
        </div>
      </div>

      <!-- 右：言語切替 -->
      <div class="mb-right">
        <a id="langBtn" href="#" aria-label="言語切替">
          <img src="assets/images/ui/lang.png" alt="Lang">
        </a>
      </div>
    </div>
  </div>

  <!-- ページ本体 -->
  <div class="page-container">
    <!-- 達成時の行（文言変更：アンケート・スペシャル） -->
    <div id="completeRow" class="complete-row" style="display:none">
      <div>🎉 6/6達成おめでとう！</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <a id="completeLink" href="post-survey.html">アンケートに答える</a>
        <a id="specialLink" href="special.html">スペシャルコンテンツ</a>
      </div>
    </div>

    <!-- 地図や起動ボタン、写真モーダルなどは既存の map.js が制御 -->
    <section id="mapRoot">
      <!-- map.js が DOM を構築・制御します -->
      <div id="cameraLaunchArea">
        <button id="openCamera" class="btn-primary" type="button">カメラを起動</button>
      </div>
      <div id="spotModalHost"><!-- map.js が写真グリッドモーダルを挿入 --></div>
    </section>
  </div>

  <!-- 既存スクリプト -->
  <script src="js/firebase.js"></script>
  <script src="js/lang.js"></script>
  <script src="js/map.js"></script>

  <script>
    // キャッシュバスター（フォールバック）
    if (!window.withV) {
      window.BUILD_V = window.BUILD_V || '20251005';
      window.withV = (url) => url + (url.includes('?') ? '&' : '?') + 'v=' + window.BUILD_V;
    }

    // ---- スタンプ帳ドロップダウンの独立開閉（他要素を押し下げない） ----
    (function(){
      const toggleBtn = document.getElementById('stampToggleBtn');
      const book = document.getElementById('stampBook');

      function closeBook(){ book.classList.remove('open'); }
      function toggleBook(ev){
        ev?.preventDefault();
        book.classList.toggle('open');
      }
      toggleBtn.addEventListener('click', toggleBook, { passive: false });

      // 外側クリックで閉じる
      document.addEventListener('click', (e) => {
        if (!book.classList.contains('open')) return;
        const inCenter = e.target.closest('.mb-center');
        if (!inCenter) closeBook();
      });

      // エスケープで閉じる
      document.addEventListener('keydown', (e)=>{
        if (e.key === 'Escape') closeBook();
      });

      // 画面回転やリサイズ時の位置ズレ対策（特にiOS）
      window.addEventListener('resize', ()=>{ /* 位置はCSSで相対配置のため特別な処理は不要 */ });
    })();

    // ---- 文言の既定値を上書き（map.js が setText しても問題ない） ----
    (function(){
      try {
        const comp = document.getElementById('completeLink');
        const spec = document.getElementById('specialLink');
        if (comp) comp.textContent = 'アンケートに答える';
        if (spec) spec.textContent = 'スペシャルコンテンツ';
      } catch {}
    })();

    // 言語切替（lang.js の仕様に合わせて必要なら書き換え）
    (function(){
      const langBtn = document.getElementById('langBtn');
      langBtn?.addEventListener('click', (e)=>{
        e.preventDefault();
        try {
          // lang.js に切替APIがある場合は呼ぶ。無ければ簡易トグル。
          const cur = localStorage.getItem('app_lang') || 'ja';
          const next = cur === 'ja' ? 'en' : 'ja';
          localStorage.setItem('app_lang', next);
          location.reload();
        } catch {
          location.href = withV('map.html?lang=en');
        }
      });
    })();
  </script>
</body>
</html>
