<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>マップ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .map-wrap { position: relative; max-width: 900px; margin: 12px auto; }
    .map-image { width: 100%; height: auto; display: block; border-radius: 12px; box-shadow: 0 6px 24px rgba(0,0,0,.08); }
    .pin { position: absolute; width: 44px; height: 44px; transform: translate(-50%, -100%); display: block; border: none; background: transparent; padding: 0; cursor: pointer; }
    .pin img { width: 100%; height: 100%; display: block; }
    .legend { max-width: 900px; margin: 8px auto 0; padding: 8px 12px; font-size: 14px; background: #f6f7fb; border-radius: 10px; color: #333; }
    .legend strong { color: #0a58ca; }
    #mapContainer { max-width: 900px; margin: 0 auto; }

    /* スタンプ帳 */
    .stamp-toggle { margin-left: 8px; }
    .stamp-book { max-width: 900px; margin: 10px auto; display: none; }
    .stamps-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .stamp-cell { background: #fff; border-radius: 12px; padding: 12px; box-shadow: 0 4px 16px rgba(0,0,0,.06); text-align: center; }
    .stamp-img { width: 100%; max-width: 140px; height: auto; display: block; margin: 6px auto 4px; }
    .stamp-placeholder { width: 100%; max-width: 140px; margin: 6px auto 4px; padding: 28px 0; border: 2px dashed #c7c7c7; border-radius: 10px; color: #888; font-weight: 600; }
    .stamp-label { font-size: 12px; color: #555; }
    .stamp-status { font-size: 13px; font-weight: 600; margin-top: 2px; }
    .obtained { color: #1a7f37; }
    .not-obtained { color: #b02a37; }
  </style>

  <!-- Firebase 読み込み -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="js/firebase.js"></script>
</head>
<body>
  <!-- メニューバー -->
  <div id="menuBar" style="max-width:900px;margin:0 auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
    <a href="tutorial.html">チュートリアル</a> |
    <a href="terms.html" target="_blank" rel="noopener">利用規約</a>
    <button id="stampToggle" class="stamp-toggle" type="button">▼スタンプ帳</button>
  </div>

  <!-- スタンプ帳（折りたたみ） -->
  <div id="stampBook" class="stamp-book">
    <div class="stamps-grid">
      <div class="stamp-cell" data-spot="spot1">
        <div class="stamp-label">スポット1</div>
        <img id="stamp1Img" class="stamp-img" src="assets/images/stamp01.png" alt="スタンプ1" style="display:none;">
        <div id="stamp1Placeholder" class="stamp-placeholder">未取得</div>
        <div id="stamp1Status" class="stamp-status not-obtained">未取得</div>
      </div>
      <div class="stamp-cell" data-spot="spot2">
        <div class="stamp-label">スポット2</div>
        <img id="stamp2Img" class="stamp-img" src="assets/images/stamp02.png" alt="スタンプ2" style="display:none;">
        <div id="stamp2Placeholder" class="stamp-placeholder">未取得</div>
        <div id="stamp2Status" class="stamp-status not-obtained">未取得</div>
      </div>
      <div class="stamp-cell" data-spot="spot3">
        <div class="stamp-label">スポット3</div>
        <img id="stamp3Img" class="stamp-img" src="assets/images/stamp03.png" alt="スタンプ3" style="display:none;">
        <div id="stamp3Placeholder" class="stamp-placeholder">未取得</div>
        <div id="stamp3Status" class="stamp-status not-obtained">未取得</div>
      </div>
    </div>
  </div>

  <!-- 地図画像＋ピン -->
  <div id="mapContainer">
    <div class="map-wrap">
      <img src="assets/images/campus-map.png" alt="学内マップ" class="map-image" id="mapImage" />

      <button class="pin" style="left:32%; top:58%;" onclick="openDirections(35.686917, 139.529194, 'Spot1')">
        <img src="assets/images/map_pin.png" alt="スポット1">
      </button>

      <button class="pin" style="left:61%; top:41%;" onclick="openDirections(35.686139, 139.533056, 'Spot2')">
        <img src="assets/images/map_pin.png" alt="スポット2">
      </button>

      <button class="pin" style="left:78%; top:72%;" onclick="openDirections(35.685667, 139.530889, 'Spot3')">
        <img src="assets/images/map_pin.png" alt="スポット3">
      </button>
    </div>

    <div class="legend">
      <p>ピンをタップすると地図アプリが開きます。案内に従いスポットへ移動し、着いたらカメラ起動→マーカー読取→AR体験へ進みます。</p>
    </div>
  </div>

  <!-- カメラ起動ボタン -->
  <button id="cameraBtn">カメラ起動</button>

  <script>
    // ▼▲切り替え
    (function(){
      var toggleBtn = document.getElementById('stampToggle');
      var book = document.getElementById('stampBook');
      if (!toggleBtn || !book) return;
      function setClosed(){
        book.style.display = 'none';
        toggleBtn.textContent = '▼スタンプ帳';
      }
      function setOpen(){
        book.style.display = 'block';
        toggleBtn.textContent = '▲スタンプ帳';
      }
      setClosed();
      toggleBtn.addEventListener('click', function(){
        var isOpen = (book.style.display === 'block');
        if (isOpen) setClosed(); else setOpen();
      });
    })();

  // スタンプ表示更新
  function setStampUI(index, obtained) {
    var img = document.getElementById('stamp' + index + 'Img');
    var ph  = document.getElementById('stamp' + index + 'Placeholder');
    var st  = document.getElementById('stamp' + index + 'Status');
    if (obtained) {
      img.style.display = 'block';
      ph.style.display = 'none';
      st.textContent = '取得済み';
      st.classList.remove('not-obtained'); st.classList.add('obtained');
    } else {
      img.style.display = 'none';
      ph.style.display = 'block';
      ph.textContent = '未取得';
      st.textContent = '未取得';
      st.classList.remove('obtained'); st.classList.add('not-obtained');
    }
  }

  // ★ localStorage フォールバックをマージ
  function getLocalStampFallback() {
    try {
      return {
        spot1: localStorage.getItem('stamp_spot1') === 'true',
        spot2: localStorage.getItem('stamp_spot2') === 'true',
        spot3: localStorage.getItem('stamp_spot3') === 'true',
      };
    } catch { return { spot1:false, spot2:false, spot3:false }; }
  }

  // ★ ユーザーIDの取得を強化（loginName優先、無ければuserId）
  function getUserName() {
    try {
      return localStorage.getItem('loginName') || localStorage.getItem('userId') || null;
    } catch { return null; }
  }

  (function loadStamps(){
    var name = getUserName();
    // まず localStorage で UI を初期反映
    var ls = getLocalStampFallback();
    setStampUI(1, !!ls.spot1);
    setStampUI(2, !!ls.spot2);
    setStampUI(3, !!ls.spot3);

    // ユーザー名 or Firebase が無いなら、ここで終了
    if (!name) return;
    if (!(window.firebase && firebase.apps && firebase.apps.length)) return;

    // Firebaseの値で上書き（取得できたものを優先）
    firebase.database().ref('users/' + name + '/stamps').once('value')
      .then(function(snap){
        var v = snap.val() || {};
        // true が一つでもあれば優先、無ければlocalStorageの値を維持
        setStampUI(1, v.spot1 === true ? true : !!ls.spot1);
        setStampUI(2, v.spot2 === true ? true : !!ls.spot2);
        setStampUI(3, v.spot3 === true ? true : !!ls.spot3);
      })
      .catch(function(){
        // 読み出し失敗時は localStorage 表示のまま
      });
  })();

    // 地図アプリを開く
    function openDirections(lat, lng, label){
      var ll = lat + ',' + lng;
      if (/Android/.test(navigator.userAgent)) {
        location.href = 'geo:' + ll + '?q=' + ll + '(' + label + ')';
      } else if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
        location.href = 'http://maps.apple.com/?daddr=' + ll + '&dirflg=w';
      } else {
        location.href = 'https://www.google.com/maps/dir/?api=1&destination=' + ll + '&travelmode=walking';
      }
    }
  </script>

  <script src="js/map.js" defer></script>
  <script>
/* ======== Stamps Loader: 多キー統合 + localStorage フォールバック ======== */

// UI反映
function setStampUI(index, obtained) {
  var img = document.getElementById('stamp' + index + 'Img');
  var ph  = document.getElementById('stamp' + index + 'Placeholder');
  var st  = document.getElementById('stamp' + index + 'Status');
  if (!img || !ph || !st) return;

  if (obtained) {
    img.style.display = 'block';
    ph.style.display  = 'none';
    st.textContent    = '取得済み';
    st.classList.remove('not-obtained'); st.classList.add('obtained');
  } else {
    img.style.display = 'none';
    ph.style.display  = 'block';
    ph.textContent    = '未取得';
    st.textContent    = '未取得';
    st.classList.remove('obtained'); st.classList.add('not-obtained');
  }
}

// localStorage フォールバック（8th Wall 側がローカル保存だけだった場合でも表示）
function getLocalStampFallback() {
  try {
    return {
      spot1: localStorage.getItem('stamp_spot1') === 'true',
      spot2: localStorage.getItem('stamp_spot2') === 'true',
      spot3: localStorage.getItem('stamp_spot3') === 'true',
    };
  } catch (_) { return { spot1:false, spot2:false, spot3:false }; }
}

// Firebase の読み取りに使うキー候補（順に試して OR マージ）
function getUserKeyCandidates() {
  var list = [];
  try {
    var ln  = localStorage.getItem('loginName');
    var uid = localStorage.getItem('userId');
    if (ln)  list.push(ln);
    if (uid && uid !== ln) list.push(uid);
  } catch (_) {}
  try {
    var qp = new URLSearchParams(location.search).get('uid');
    if (qp && list.indexOf(qp) === -1) list.push(qp);
  } catch (_) {}
  if (list.indexOf('guest') === -1) list.push('guest');
  return list;
}

async function fetchStampsOnce(key) {
  try {
    if (!(window.firebase && firebase.apps && firebase.apps.length)) return {};
    var snap = await firebase.database().ref('users/' + key + '/stamps').once('value');
    var v = snap.val() || {};
    console.log('[map] fetched', key, v);
    return v;
  } catch (e) {
    console.warn('[map] read failed for', key, e && e.message ? e.message : e);
    return {};
  }
}

async function loadAndRenderStamps() {
  // まずローカルだけで即時反映（体感を早く）
  var merged = getLocalStampFallback();
  setStampUI(1, !!merged.spot1);
  setStampUI(2, !!merged.spot2);
  setStampUI(3, !!merged.spot3);

  // Firebase 未初期化ならここで終わり（コンソールだけ通知）
  if (!(window.firebase && firebase.apps && firebase.apps.length)) {
    console.log('[map] firebase not ready. local fallback only');
    return;
  }

  // loginName / userId / URL uid / guest を順に読んで OR マージ
  var keys = getUserKeyCandidates();
  for (var i = 0; i < keys.length; i++) {
    var v = await fetchStampsOnce(keys[i]);
    merged.spot1 = merged.spot1 || !!v.spot1;
    merged.spot2 = merged.spot2 || !!v.spot2;
    merged.spot3 = merged.spot3 || !!v.spot3;
    if (merged.spot1 && merged.spot2 && merged.spot3) break; // 3つ揃ったら早期終了
  }

  setStampUI(1, !!merged.spot1);
  setStampUI(2, !!merged.spot2);
  setStampUI(3, !!merged.spot3);
}

// 初回ロード & 画面復帰で再取得（explanation → map 戻り対策）
document.addEventListener('DOMContentLoaded', loadAndRenderStamps);
document.addEventListener('visibilitychange', function () {
  if (!document.hidden) loadAndRenderStamps();
});
/* ===================================================================== */
</script>
</body>
</html>