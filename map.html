<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>マップ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .map-wrap { position: relative; max-width: 900px; margin: 12px auto; }
    .map-image { width: 100%; height: auto; display: block; border-radius: 12px; box-shadow: 0 6px 24px rgba(0,0,0,.08); }
    .pin { position: absolute; width: 44px; height: 44px; transform: translate(-50%, -100%); display: block; border: none; background: transparent; padding: 0; cursor: pointer; }
    .pin img { width: 100%; height: 100%; display: block; }
    .legend { max-width: 900px; margin: 8px auto 0; padding: 8px 12px; font-size: 14px; background: #f6f7fb; border-radius: 10px; color: #333; }
    .legend strong { color: #0a58ca; }
    #mapContainer { max-width: 900px; margin: 0 auto; }

    /* スタンプ帳 */
    .stamp-toggle { margin-left: 8px; }
    .stamp-book { max-width: 900px; margin: 10px auto; display: none; }
    .stamps-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .stamp-cell { background: #fff; border-radius: 12px; padding: 12px; box-shadow: 0 4px 16px rgba(0,0,0,.06); text-align: center; }
    .stamp-img { width: 100%; max-width: 140px; height: auto; display: block; margin: 6px auto 4px; }
    .stamp-placeholder { width: 100%; max-width: 140px; margin: 6px auto 4px; padding: 28px 0; border: 2px dashed #c7c7c7; border-radius: 10px; color: #888; font-weight: 600; }
    .stamp-label { font-size: 12px; color: #555; }
    .stamp-status { font-size: 13px; font-weight: 600; margin-top: 2px; }
    .obtained { color: #1a7f37; }
    .not-obtained { color: #b02a37; }
  </style>

  <!-- Firebase（スタンプ読取用） -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="js/firebase.js"></script>
</head>
<body>
  <!-- メニューバー -->
  <div id="menuBar" style="max-width:900px;margin:0 auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
    <a href="tutorial.html">チュートリアル</a> |
    <a href="terms.html" target="_blank" rel="noopener">利用規約</a>
    <button id="stampToggle" class="stamp-toggle" type="button">▼スタンプ帳</button>
  </div>

  <!-- スタンプ帳（折りたたみ） -->
  <div id="stampBook" class="stamp-book">
    <div class="stamps-grid">
      <!-- スポット1 -->
      <div class="stamp-cell" data-spot="spot1">
        <div class="stamp-label">スポット1</div>
        <img id="stamp1Img" class="stamp-img" src="assets/images/stamp01.png" alt="スタンプ1" style="display:none;">
        <div id="stamp1Placeholder" class="stamp-placeholder">［未取得］</div>
        <div id="stamp1Status" class="stamp-status not-obtained">未取得</div>
      </div>
      <!-- スポット2 -->
      <div class="stamp-cell" data-spot="spot2">
        <div class="stamp-label">スポット2</div>
        <img id="stamp2Img" class="stamp-img" src="assets/images/stamp02.png" alt="スタンプ2" style="display:none;">
        <div id="stamp2Placeholder" class="stamp-placeholder">［未取得］</div>
        <div id="stamp2Status" class="stamp-status not-obtained">未取得</div>
      </div>
      <!-- スポット3 -->
      <div class="stamp-cell" data-spot="spot3">
        <div class="stamp-label">スポット3</div>
        <img id="stamp3Img" class="stamp-img" src="assets/images/stamp03.png" alt="スタンプ3" style="display:none;">
        <div id="stamp3Placeholder" class="stamp-placeholder">［未取得］</div>
        <div id="stamp3Status" class="stamp-status not-obtained">未取得</div>
      </div>
    </div>
  </div>

  <!-- 地図画像＋ピン（A案：端末別ディープリンク） -->
  <div id="mapContainer">
    <div class="map-wrap">
      <img src="assets/images/campus-map.png" alt="学内マップ" class="map-image" id="mapImage" />

      <!-- ピン1 -->
      <button class="pin" style="left:32%; top:58%;" type="button"
              onclick="openDirections(35.686917, 139.529194, 'Spot1')"
              aria-label="スポット1へ（徒歩案内）">
        <img src="assets/images/map_pin.png" alt="スポット1">
      </button>

      <!-- ピン2 -->
      <button class="pin" style="left:61%; top:41%;" type="button"
              onclick="openDirections(35.686139, 139.533056, 'Spot2')"
              aria-label="スポット2へ（徒歩案内）">
        <img src="assets/images/map_pin.png" alt="スポット2">
      </button>

      <!-- ピン3 -->
      <button class="pin" style="left:78%; top:72%;" type="button"
              onclick="openDirections(35.685667, 139.530889, 'Spot3')"
              aria-label="スポット3へ（徒歩案内）">
        <img src="assets/images/map_pin.png" alt="スポット3">
      </button>
    </div>

    <div class="legend">
      <p>
        ピンをタップすると端末に最適な地図アプリが開きます（AndroidはGoogleマップ、iOSはAppleマップ優先）。<br>
        案内に従ってスポットへ移動 → 着いたら <strong>カメラを起動してマーカーを読み取り</strong> → AR を体験したあと解説ページへ進みます。
      </p>
    </div>
  </div>

  <!-- カメラ起動ボタン（既存フローを利用） -->
  <button id="cameraBtn">カメラ起動</button>

  <!-- 端末別ディープリンク＋フォールバック -->
  <script>
    (function(){
      function isiOS(){ return /iPad|iPhone|iPod/.test(navigator.userAgent); }
      function isAndroid(){ return /Android/.test(navigator.userAgent); }

      window.openDirections = function(lat, lng, label){
        var ll = lat + ',' + lng;
        var name = encodeURIComponent(label || 'Destination');
        var urls = [];

        if (isAndroid()) {
          urls.push('geo:' + ll + '?q=' + ll + '(' + name + ')');
          urls.push('https://maps.google.com/?daddr=' + ll);
        } else if (isiOS()) {
          urls.push('http://maps.apple.com/?daddr=' + ll + '&dirflg=w');
          urls.push('comgooglemaps://?daddr=' + ll + '&directionsmode=walking');
          urls.push('https://www.google.com/maps/dir/?api=1&destination=' + ll + '&travelmode=walking');
        } else {
          urls.push('https://www.google.com/maps/dir/?api=1&destination=' + ll + '&travelmode=walking');
        }

        location.href = urls[0];
        setTimeout(function(){
          if (document.visibilityState === 'visible' && urls[1]) {
            location.href = urls[1];
          }
        }, 800);
      };
    })();
  </script>

  <!-- スタンプ帳：Firebase/LocalStorage から読み込み -->
  <script>
    (function(){
      var toggle = document.getElementById('stampToggle');
      var book   = document.getElementById('stampBook');
      if (toggle && book) {
        toggle.addEventListener('click', function(){
          book.style.display = (book.style.display === 'none' || !book.style.display) ? 'block' : 'none';
        });
      }

      function setStampUI(index, obtained) {
        var img = document.getElementById('stamp' + index + 'Img');
        var ph  = document.getElementById('stamp' + index + 'Placeholder');
        var st  = document.getElementById('stamp' + index + 'Status');
        if (!img || !ph || !st) return;
        if (obtained) {
          img.style.display = 'block';
          ph.style.display  = 'none';
          st.textContent    = '取得済み';
          st.classList.remove('not-obtained');
          st.classList.add('obtained');
        } else {
          img.style.display = 'none';
          ph.style.display  = 'block';
          st.textContent    = '未取得';
          st.classList.remove('obtained');
          st.classList.add('not-obtained');
        }
      }

      function fallbackFromLocalStorage() {
        try {
          var s1 = !!localStorage.getItem('stamp_spot1'); // 'true' などを想定
          var s2 = !!localStorage.getItem('stamp_spot2');
          var s3 = !!localStorage.getItem('stamp_spot3');
          setStampUI(1, s1);
          setStampUI(2, s2);
          setStampUI(3, s3);
        } catch (_) {
          // 何も表示できない時は全未取得
          setStampUI(1, false);
          setStampUI(2, false);
          setStampUI(3, false);
        }
      }

      function loadFromFirebase() {
        try {
          // ログイン名
          var name = null;
          try { name = localStorage.getItem('loginName'); } catch(_){}
          if (!name) { fallbackFromLocalStorage(); return; }

          if (!(window.firebase && firebase.apps && firebase.apps.length)) {
            fallbackFromLocalStorage();
            return;
          }

          var ref = firebase.database().ref('users/' + name + '/stamps');
          ref.once('value').then(function(snap){
            var v = snap.val() || {};
            setStampUI(1, !!v.spot1);
            setStampUI(2, !!v.spot2);
            setStampUI(3, !!v.spot3);
          }).catch(function(){
            fallbackFromLocalStorage();
          });
        } catch (e) {
          console.warn('[stampbook] load error:', e);
          fallbackFromLocalStorage();
        }
      }

      // 初期ロード
      loadFromFirebase();
    })();
  </script>

  <!-- 既存のカメラ起動フロー（ピンのクリック処理は本HTMLが担当するため、map.jsに .pin のクリック処理が残っていれば削除してください） -->
  <script src="js/map.js" defer></script>
</body>
</html>
