<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ« | ARã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    :root{
      --brand:#005ABB;
      --text:#111;
      --muted:#666;
      --bg:#f6f7fb;
      --card:#fff;
      --radius:16px;
      --shadow:0 12px 32px rgba(0,0,0,.10);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,sans-serif;}
    .wrap{min-height:100vh;display:flex;flex-direction:column;margin:0 auto;max-width:860px;padding:12px}
    header{padding:8px 8px 4px}
    h1{margin:0;font-size:clamp(18px,4.6vw,22px);font-weight:900;color:var(--brand)}
    .stage{
      flex:1;display:flex;flex-direction:column;gap:12px;margin-top:6px
    }
    .card{
      background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);
      padding:10px 10px 14px;display:flex;flex-direction:column;gap:10px;min-height:64vh
    }
    .hero{
      display:flex;align-items:center;justify-content:center;flex:1;min-height:42vh;
      background:#eaf0fb;border-radius:12px;overflow:hidden
    }
    .hero img{width:100%;height:100%;object-fit:contain}
    .bottom{
      margin-top:auto;background:#fff;border-radius:12px;padding:12px 12px 16px;border:1px solid #e6ecf8
    }
    .text{
      font-size:clamp(14px,4.2vw,16px);line-height:1.7;margin:0 0 8px;color:#161b22
    }
    .pager{
      display:flex;gap:6px;justify-content:center;align-items:center;margin:10px 0 6px
    }
    .dot{
      width:10px;height:10px;border-radius:999px;background:#c9d6ee;display:inline-block
    }
    .dot.active{background:#1c3f87}
    .btn{
      appearance:none;border:0;border-radius:12px;padding:14px 16px;width:100%;
      font-weight:900;cursor:pointer;display:inline-block;text-align:center
    }
    .btn-primary{background:var(--brand);color:#fff;box-shadow:0 10px 26px rgba(0,90,187,.26)}
    .btn-ghost{background:#eef3fb;color:#0a1d3a}
    .btn-text{background:transparent;color:#3b5fb7;font-weight:800}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .row .left{display:flex;align-items:center;gap:8px}
    .check{width:20px;height:20px}
    .tiny{font-size:clamp(12px,3.4vw,13px);color:#444}
    .note{font-size:clamp(12px,3.6vw,14px);color:#374151;margin:6px 0 0}
    .actions{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .hidden{display:none !important}
    .linklike{display:inline-block;padding:10px 12px;border-radius:10px;border:1px solid #d7def0;background:#f5f8ff;color:#0a1d3a;font-weight:800;text-decoration:none;text-align:center}
    .foot{padding:8px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ã¯ã˜ã‚ã«ï¼ˆãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ï¼‰</h1>
    </header>

    <main class="stage">
      <section class="card" aria-live="polite">
        <div class="hero" id="hero"><img id="heroImg" src="" alt="ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ç”»åƒ" /></div>

        <div class="bottom">
          <p class="text" id="pageText">â€¦</p>

          <!-- ãƒšãƒ¼ã‚¸1ã ã‘è¡¨ç¤ºï¼šåˆ©ç”¨è¦ç´„ + åŒæ„ãƒã‚§ãƒƒã‚¯ + æ¬¡ã¸ -->
          <div id="termsBlock" class="hidden">
            <div class="actions">
              <a class="linklike" href="terms.html" target="_blank" rel="noopener">åˆ©ç”¨è¦ç´„ã‚’ã²ã‚‰ã</a>
              <div class="row">
                <label class="left tiny">
                  <input id="agree" type="checkbox" class="check" />
                  <span>åˆ©ç”¨è¦ç´„ã‚’èª­ã¿ã€åŒæ„ã—ã¾ã™ã€‚</span>
                </label>
              </div>
              <button id="nextAgree" class="btn btn-primary hidden">æ¬¡ã¸</button>
            </div>
          </div>

          <!-- ãƒšãƒ¼ã‚¸2ã€œ7,8 å…±é€šï¼šãƒšãƒ¼ã‚¸ãƒ£ + æ¬¡ã¸/ã¯ã˜ã‚ã‚‹ + skip -->
          <div id="flowBlock">
            <div class="pager" id="pager"></div>
            <div class="actions">
              <button id="nextBtn" class="btn btn-primary">æ¬¡ã¸</button>
              <button id="skipBtn" class="btn btn-ghost">skip</button>
            </div>
            <p id="hint" class="note hidden"></p>
          </div>
        </div>
      </section>
    </main>

    <div class="foot"></div>
  </div>

  <script>
    (function(){
      // --- ç‰ˆæ•°ã‚¯ã‚¨ãƒªã‚’ä»˜ä¸ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿ï¼‰ ---
      if (!window.withV) {
        window.BUILD_V = window.BUILD_V || '20251003';
        window.withV = (url)=> url + (url.includes('?')?'&':'?') + 'v=' + window.BUILD_V;
      }

      const heroImg = document.getElementById('heroImg');
      const pageText = document.getElementById('pageText');
      const pager = document.getElementById('pager');
      const flowBlock = document.getElementById('flowBlock');
      const termsBlock = document.getElementById('termsBlock');
      const nextBtn = document.getElementById('nextBtn');
      const skipBtn = document.getElementById('skipBtn');
      const agree = document.getElementById('agree');
      const nextAgree = document.getElementById('nextAgree');
      const hint = document.getElementById('hint');

      // 8ãƒšãƒ¼ã‚¸ã®ãƒ†ã‚­ã‚¹ãƒˆï¼ˆã”æŒ‡å®šã®æ–‡é¢ï¼‰
      const PAGES = [
        { txt: 'ARã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼ã¸ã‚ˆã†ã“ãï¼æœ¬ã‚¢ãƒ—ãƒªã¯ğ“¸ğ“¸ã«ã‚ˆã‚‹å’æ¥­ç ”ç©¶ã®ãŸã‚ã«é–‹ç™ºã•ã‚ŒãŸã‚‚ã®ã§ã™ã€‚ä»¥ä¸‹ã®æ³¨æ„äº‹é …ã‚’èª­ã¿ã€åŒæ„ã—ã¦ãã ã•ã‚‹æ–¹ã¯ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚', needAgree: true },
        { txt: 'ã‚¹ã‚¿ãƒ³ãƒ—å°ã«è²¼ã£ã¦ã‚ã‚‹ã‚¿ã‚°ã‚’èª­ã‚“ã§ãã ã•ã„ã€‚' },
        { txt: 'ã€Œã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã€ã‚’æŠ¼ã—ã€ä»Šã„ã‚‹å ´æ‰€ã‚’é¸æŠã—ã¾ã™ã€‚' },
        { txt: 'ã‚«ãƒ¡ãƒ©ã¨ä½ç½®æƒ…å ±ã®è¨±å¯ã‚’ã—ã¦ãã ã•ã„ã€‚', requestPerm: true },
        { txt: 'ARã‚’è¦‹ã¦ã€æ¥½ã—ã¿ã¾ã—ã‚‡ã†ï¼' },
        { txt: 'ã“ã“ã‹ã‚‰ã‚¹ã‚¿ãƒ³ãƒ—ãŒè²°ãˆã¾ã™ï¼' },
        { txt: 'ã‚¯ã‚¤ã‚º&è§£èª¬ãƒšãƒ¼ã‚¸ã¸è¡Œãã€ã‚¯ã‚¤ã‚ºã«æŒ‘æˆ¦ã—ã¾ã—ã‚‡ã†ã€‚' },
        { txt: '6ã¤é›†ã‚ãŸã‚‰ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆï¼ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã«ãŠç­”ãˆã„ãŸã ãã¨ã‚¹ãƒšã‚·ãƒ£ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¦‹ã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã™' },
      ];

      let idx = 0;
      let permRequested = false;

      function imgPath(i){
        const n = String(i+1).padStart(2,'0'); // 01..08
        return `assets/images/tutorial_image${n}.png`; // å¿…è¦ãªã‚‰æ‹¡å¼µå­å¤‰æ›´
      }

      function renderPager(){
        pager.innerHTML = '';
        for (let i=0;i<PAGES.length;i++){
          const d = document.createElement('span');
          d.className = 'dot' + (i===idx?' active':'');
          pager.appendChild(d);
        }
      }

      function navToMap(){
        const url = typeof withV === 'function' ? withV('map.html') : 'map.html';
        try{ localStorage.setItem('tutorial_done','1'); }catch(e){}
        location.href = url;
      }

      async function requestPermissionsIfNeeded(){
        // ãƒšãƒ¼ã‚¸4ã§ä¸€åº¦ã ã‘è©¦è¡Œ
        if (!PAGES[idx]?.requestPerm || permRequested) return;
        permRequested = true;
        hint.classList.remove('hidden');
        hint.textContent = 'æ¨©é™ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­â€¦ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã«å¾“ã£ã¦ãã ã•ã„ï¼‰';

        // ã‚«ãƒ¡ãƒ©
        try{
          if (navigator.mediaDevices?.getUserMedia){
            await navigator.mediaDevices.getUserMedia({video:true});
          }
        }catch(e){
          // å¤±æ•—ã—ã¦ã‚‚ç¶šè¡Œ
        }

        // ä½ç½®æƒ…å ±
        try{
          if (navigator.geolocation){
            await new Promise((res)=> {
              navigator.geolocation.getCurrentPosition(()=>res(), ()=>res(), {enableHighAccuracy:true, timeout:3000});
            });
          }
        }catch(e){}

        hint.textContent = 'æ¨©é™ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚ç¶šè¡Œã§ãã¾ã™ã€‚';
        setTimeout(()=> hint.classList.add('hidden'), 1800);
      }

      function render(){
        const page = PAGES[idx];
        // ç”»åƒãƒ»ãƒ†ã‚­ã‚¹ãƒˆ
        heroImg.src = imgPath(idx);
        heroImg.alt = `ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ« ${idx+1}æšç›®`;
        pageText.textContent = page.txt;

        // ãƒšãƒ¼ã‚¸ãƒ£
        renderPager();

        // ãƒœã‚¿ãƒ³æ–‡è¨€
        nextBtn.textContent = (idx === PAGES.length-1) ? 'ã¯ã˜ã‚ã‚‹' : 'æ¬¡ã¸';

        // ãƒšãƒ¼ã‚¸1å°‚ç”¨UIï¼ˆåˆ©ç”¨è¦ç´„ï¼‰
        if (page.needAgree){
          termsBlock.classList.remove('hidden');
          flowBlock.classList.add('hidden');  // ä¸‹éƒ¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ termsBlock å†…ã®UIã§
        }else{
          termsBlock.classList.add('hidden');
          flowBlock.classList.remove('hidden');
        }

        // ãƒšãƒ¼ã‚¸4ï¼šæ¨©é™ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        if (page.requestPerm){
          requestPermissionsIfNeeded();
        }else{
          hint.classList.add('hidden');
        }
      }

      // åŒæ„ãƒã‚§ãƒƒã‚¯ â†’ ã€Œæ¬¡ã¸ã€è¡¨ç¤º
      agree?.addEventListener('change', ()=>{
        if (agree.checked){
          nextAgree.classList.remove('hidden');
        }else{
          nextAgree.classList.add('hidden');
        }
      });

      // æ¬¡ã¸ï¼ˆãƒšãƒ¼ã‚¸1ã®ã€Œæ¬¡ã¸ã€ in termsBlockï¼‰
      nextAgree?.addEventListener('click', ()=>{
        if (!agree.checked) return;
        idx = Math.min(idx+1, PAGES.length-1);
        render();
      });

      // å…±é€šï¼šæ¬¡ã¸ / ã¯ã˜ã‚ã‚‹
      nextBtn.addEventListener('click', ()=>{
        if (idx === PAGES.length-1){
          navToMap();
          return;
        }
        idx = Math.min(idx+1, PAGES.length-1);
        render();
      });

      // å…±é€šï¼šskip
      skipBtn.addEventListener('click', navToMap);

      // åˆæœŸè¡¨ç¤º
      render();
    })();
  </script>
</body>
</html>
