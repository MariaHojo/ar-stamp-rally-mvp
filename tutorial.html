<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>チュートリアル</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    :root{ --accent:#005ABB; --text:#111; --muted:#444; --bg:#fff; --card:#ffffff; --shadow:0 12px 32px rgba(0,0,0,.08); --radius:16px; }
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;line-height:1.6}
    .wrap{max-width:960px;margin:0 auto;padding:clamp(10px,3vw,16px);min-height:100vh;display:flex;flex-direction:column;position:relative}
    header{padding:4px 0 8px; position:relative}
    h1{font-size:20px;margin:0;font-weight:900}
    [data-lang-anchor]{position:absolute;right:8px;top:8px}

    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:clamp(12px,3vw,18px);display:flex;flex-direction:column;gap:12px;min-height:60vh}
    .hero{width:100%;aspect-ratio:4/3;border-radius:12px;overflow:hidden;background:#f3f6fc;border:1px solid #e9eef6;display:flex;align-items:center;justify-content:center}
    .hero img{width:100%;height:100%;object-fit:cover;display:block}
    .panel{margin-top:auto;background:#f7f9fe;border:1px solid #e3eaf6;border-radius:12px;padding:12px}
    .panel p{margin:.4em 0}
    .pageDots{margin-top:6px;text-align:center;font-size:0}
    .dot{display:inline-block;width:9px;height:9px;margin:0 3px;border-radius:999px;background:#c9d6ee}
    .dot.active{background:var(--accent)}

    .termsBox{height:min(40vh, 320px);overflow:auto;background:#fff;border:1px solid #dfe7f7;border-radius:12px;padding:12px;line-height:1.55;font-size:14px;color:#222}
    .agreeLine{display:flex;align-items:center;gap:10px;margin-top:10px}
    .agreeLine small{color:#333}

    .ctaRow{display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;margin-top:10px}
    .btn{appearance:none;border:0;border-radius:12px;padding:14px 16px;font-weight:900;cursor:pointer;background:var(--accent);color:#fff;box-shadow:0 10px 28px rgba(0,90,187,.25);flex:1;min-width:160px;text-align:center}
    .btn[disabled]{opacity:.45;box-shadow:none;cursor:not-allowed}
    .btn-secondary{background:#e9eef6;color:#111;box-shadow:none}
    .btn-ghost{background:transparent;color:var(--accent);box-shadow:none}
    .footerSpace{height:max(8px, env(safe-area-inset-bottom))}
    @media (max-width:560px){ .btn{min-width:0} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 id="ttl">チュートリアル</h1>
      <div data-lang-anchor></div>
    </header>

    <main class="card" id="slideRoot" aria-live="polite">
      <div class="hero" aria-hidden="true">
        <img id="slideImg" src="assets/images/tutorial_image01.png" alt="チュートリアル画像">
      </div>

      <section class="panel">
        <div id="slideText" style="min-height:4lh"></div>

        <!-- 1ページ目：規約スクロール＋同意 -->
        <div id="termsArea" style="display:none; margin-top:10px;">
          <div class="termsBox" id="termsBox" tabindex="0" aria-label="利用規約本文（スクロール可）">
            <!-- 文面は i18n で差し替え -->
            <h3 id="termsHdr" style="margin:.2em 0 0;font-size:16px">プライバシーポリシー・ご利用上の注意</h3>
            <div id="termsBody">
              <!-- i18n で注入 -->
            </div>
          </div>
          <label class="agreeLine">
            <input id="agreeChk" type="checkbox" />
            <small id="agreeLbl">利用規約を読み、同意します。</small>
          </label>
        </div>

        <div class="pageDots" aria-hidden="true" id="dots"></div>

        <div class="ctaRow">
          <button id="prevBtn" class="btn btn-secondary" type="button">戻る</button>
          <button id="nextBtn" class="btn" type="button">次へ</button>
        </div>
        <div class="ctaRow" style="margin-top:2px">
          <button id="skipBtn" class="btn-ghost" type="button">skip</button>
        </div>
      </section>
    </main>

    <div class="footerSpace"></div>
  </div>

  <script>
    if (!window.withV) {
      window.BUILD_V = window.BUILD_V || '20251009';
      window.withV = (url) => url + (url.includes('?') ? '&' : '?') + 'v=' + window.BUILD_V;
    }
  </script>
  <script src="js/lang.js"></script>
  <script>
    /* ====== i18n 定義 ====== */
    const I18N = {
      ja: {
        pageTitle: 'チュートリアル',
        slides: [
          'ARスタンプラリーへようこそ！本アプリは𓏸𓏸による卒業研究のために開発されたものです。以下の注意事項を読み、同意してくださる方はチェックを入れてください。',
          'スタンプ台に貼ってあるタグを読んでください。',
          '「カメラを起動」を押し、今いる場所を選択します。',
          'カメラと位置情報の許可をしてください。',
          'ARを見て、楽しみましょう！',
          'ここからスタンプが貰えます！',
          'クイズ&解説ページへ行き、クイズに挑戦しましょう。',
          '6つ集めたらコンプリート！アンケートにお答えいただくとスペシャルコンテンツを見ることが出来ます。最後に「はじめる」を押してください。'
        ],
        termsHdr: 'プライバシーポリシー・ご利用上の注意',
        termsHtml: `
          <p>本アプリケーションは大学の卒業研究の一環として実施されています。アンケート等でご記入いただいた情報は、研究目的のみに使用し、研究目的以外には一切利用いたしません。</p>
          <p>収集したデータは匿名化し、統計的に処理・分析します。結果を公表する際にも個人が識別される情報は含みません。第三者への提供も、利用者の同意なく行いません。</p>
          <p>本アプリはAR体験を含み、歩行や屋外での利用を伴う場合があります。ご利用の際は周囲の安全に十分ご注意ください。AR利用中の事故・ケガ・機器の破損について、運営は責任を負いかねます。</p>
          <p>本アプリは無料でご利用いただけますが、通信費は利用者のご負担となります。</p>
        `,
        agreeLbl: '利用規約を読み、同意します。',
        btnPrev: '戻る', btnNext: '次へ', btnStart: 'はじめる', btnSkip: 'skip'
      },
      en: {
        pageTitle: 'Tutorial',
        slides: [
          'Welcome to the AR Stamp Rally! This app was developed as part of a graduation project. Please read the notes below and check the box if you agree.',
          'Scan the tag attached to the stamp stand.',
          'Tap “Open Camera” and select your current spot.',
          'Please allow camera and location permissions.',
          'Enjoy the AR experience!',
          'You can get stamps from here!',
          'Go to the Quiz & Explanation page and try the quiz.',
          'Collect all six to complete! If you answer the survey, you can view special contents. Finally, tap “Start”.'
        ],
        termsHdr: 'Privacy Policy & Safety Notes',
        termsHtml: `
          <p>This application is conducted as part of a university graduation project. Information you provide (e.g., in surveys) will only be used for research purposes and never for any other purpose.</p>
          <p>Collected data will be anonymized and analyzed statistically. Publications will not contain personally identifiable information. We will not provide personal data to third parties without your consent.</p>
          <p>This app includes AR experiences and may involve walking or outdoor use. Please be mindful of your surroundings. We cannot accept responsibility for accidents, injuries, or device damage during AR use.</p>
          <p>The app is free to use; however, communication fees (e.g., mobile data) are borne by the user.</p>
        `,
        agreeLbl: 'I have read and agree to the terms.',
        btnPrev: 'Back', btnNext: 'Next', btnStart: 'Start', btnSkip: 'skip'
      }
    };

    /* ====== スライド定義 ====== */
    const slides = [
      { img: 'assets/images/tutorial_image01.png', showTerms: true },
      { img: 'assets/images/tutorial_image02.png' },
      { img: 'assets/images/tutorial_image03.png' },
      { img: 'assets/images/tutorial_image04.png' },
      { img: 'assets/images/tutorial_image05.png' },
      { img: 'assets/images/tutorial_image06.png' },
      { img: 'assets/images/tutorial_image07.png' },
      { img: 'assets/images/tutorial_image08.png' },
    ];

    // 要素取得
    const imgEl   = document.getElementById('slideImg');
    const textEl  = document.getElementById('slideText');
    const termsEl = document.getElementById('termsArea');
    const agreeEl = document.getElementById('agreeChk');
    const agreeLbl= document.getElementById('agreeLbl');
    const dotsEl  = document.getElementById('dots');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const skipBtn = document.getElementById('skipBtn');

    let idx = 0;

    function renderDots(){
      dotsEl.innerHTML = '';
      for (let i=0;i<slides.length;i++){
        const d = document.createElement('span');
        d.className = 'dot' + (i===idx ? ' active' : '');
        dotsEl.appendChild(d);
      }
    }

    window.applyI18n = function(){
      const lang = window.getLang();
      const t = I18N[lang];
      document.documentElement.setAttribute('lang', lang);
      document.title = t.pageTitle;
      document.getElementById('ttl').textContent = t.pageTitle;
      document.getElementById('termsHdr').textContent = t.termsHdr;
      document.getElementById('termsBody').innerHTML = t.termsHtml;
      agreeLbl.textContent = t.agreeLbl;
      prevBtn.textContent = t.btnPrev;
      nextBtn.textContent = (idx === slides.length - 1) ? t.btnStart : t.btnNext;
      skipBtn.textContent = t.btnSkip;
      // スライド本文
      textEl.innerHTML = t.slides[idx];
    };

    function render(){
      const lang = window.getLang();
      const t = I18N[lang];
      const s = slides[idx];
      imgEl.src = s.img;
      textEl.innerHTML = t.slides[idx];

      if (s.showTerms){ termsEl.style.display = 'block'; }
      else { termsEl.style.display = 'none'; }

      document.getElementById('nextBtn').textContent = (idx === slides.length - 1) ? t.btnStart : t.btnNext;
      prevBtn.style.visibility = (idx === 0 ? 'hidden' : 'visible');
      nextBtn.disabled = (idx === 0 && !agreeEl.checked);
      renderDots();
    }

    function goNext(){
      if (idx === 3){ // 権限（任意）
        try{
          navigator.mediaDevices?.getUserMedia?.({video:true}).then(s=>s.getTracks().forEach(t=>t.stop()));
          navigator.geolocation?.getCurrentPosition?.(()=>{},()=>{}, {enableHighAccuracy:true, timeout:2000});
        }catch(e){}
      }
      const lang = window.getLang();
      const t = I18N[lang];
      if (idx < slides.length - 1){ idx++; render(); window.applyI18n(); }
      else {
        try { localStorage.setItem('tutorial_done','1'); } catch {}
        location.href = withV('map.html');
      }
    }
    function goPrev(){ if (idx > 0){ idx--; render(); window.applyI18n(); } }
    function skipAll(){ try { localStorage.setItem('tutorial_done','1'); } catch {} location.href = withV('map.html'); }

    agreeEl.addEventListener('change', ()=>{ if (idx === 0){ nextBtn.disabled = !agreeEl.checked; }});
    prevBtn.addEventListener('click', goPrev);
    nextBtn.addEventListener('click', goNext);
    skipBtn.addEventListener('click', skipAll);

    document.addEventListener('DOMContentLoaded', ()=>{
      window.injectLangUI();
      window.applyI18n();
      render();
    });
  </script>
</body>
</html>
